# AI è¶‹åŠ¿åˆ†æè¶…æ—¶é—®é¢˜ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

**ç—‡çŠ¶**:
- API è¯·æ±‚è¶…æ—¶ï¼š93 ç§’
- é‡è¯• 2-3 æ¬¡åè¿›å…¥ Fallback æ¨¡å¼
- é”™è¯¯æ—¥å¿—ï¼š`Request timed out`

**é”™è¯¯æ—¥å¿—**:
```
[Fallback] AI service failed (TIMEOUT), using fallback method { error: 'Request timed out' }
[TrendAnalysis] AI failed, using rule-based analysis
POST /api/ai/trend 200 in 93s (compile: 1008Âµs, render: 93s)
[RetryHandler] Attempt 2/3 failed. Retrying in 2000ms... { error: 'Request timeout' }
```

## ğŸ” æ ¹å› åˆ†æ

### 1. **é‡è¯•ç­–ç•¥è¶…æ—¶ç´¯ç§¯**
- é‡è¯•è¶…æ—¶ï¼š30 ç§’/æ¬¡
- é‡è¯•æ¬¡æ•°ï¼š3 æ¬¡
- æ€»è¶…æ—¶æ—¶é—´ï¼š30s Ã— 3 = 90s â‰ˆ 93s

### 2. **DeepSeek å®¢æˆ·ç«¯é…ç½®ç¼ºå¤±**
- âŒ æ²¡æœ‰è®¾ç½®å…¨å±€è¶…æ—¶
- âŒ æ²¡æœ‰ç¦ç”¨ SDK å†…éƒ¨é‡è¯•ï¼ˆå¯¼è‡´åŒé‡é‡è¯•ï¼‰
- âŒ å¯èƒ½å¯¼è‡´è¯·æ±‚æ— é™æœŸæŒ‚èµ·

### 3. **API è·¯ç”±ç¼ºå°‘è¶…æ—¶é…ç½®**
- Next.js API è·¯ç”±æ²¡æœ‰è®¾ç½® `maxDuration`
- é»˜è®¤å¯èƒ½å…è®¸æ›´é•¿çš„æ‰§è¡Œæ—¶é—´

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. **DeepSeek å®¢æˆ·ç«¯ä¼˜åŒ–** (`lib/ai/deepseek-client.ts`)

```typescript
export const deepseek = new OpenAI({
  apiKey,
  baseURL,
  timeout: 20000,  // âœ… 20 ç§’å•æ¬¡è¯·æ±‚è¶…æ—¶
  maxRetries: 0,   // âœ… ç¦ç”¨ SDK å†…éƒ¨é‡è¯•ï¼ˆæˆ‘ä»¬è‡ªå·±å¤„ç†ï¼‰
});
```

**ä¼˜åŠ¿**:
- æ¯æ¬¡è¯·æ±‚æœ€å¤š 20 ç§’
- é¿å… SDK å’Œåº”ç”¨å±‚çš„åŒé‡é‡è¯•
- æ›´å¿«çš„å¤±è´¥æ£€æµ‹

### 2. **é‡è¯•ç­–ç•¥ä¼˜åŒ–** (`lib/ai/utils/retry-handler.ts`)

æ–°å¢ `quick` é¢„è®¾ï¼š
```typescript
quick: {
  maxRetries: 2,           // æœ€å¤šé‡è¯• 2 æ¬¡
  backoff: 'linear',       // çº¿æ€§é€€é¿ï¼ˆ1s, 2sï¼‰
  timeout: 15000,          // 15 ç§’è¶…æ—¶
}
```

**é‡è¯•æ—¶é—´è½´**:
- ç¬¬ 1 æ¬¡ï¼š0s - 15sï¼ˆDeepSeek 20s + é‡è¯• 15s ä¿æŠ¤ï¼‰
- ç­‰å¾…ï¼š1s
- ç¬¬ 2 æ¬¡ï¼š16s - 31s
- ç­‰å¾…ï¼š2s
- ç¬¬ 3 æ¬¡ï¼ˆFallbackï¼‰ï¼š33s

**æ€»æ—¶é—´**: æœ€å¤š 35 ç§’ï¼ˆç›¸æ¯”ä¹‹å‰çš„ 93 ç§’å‡å°‘ 62%ï¼‰

### 3. **è¶‹åŠ¿åˆ†ææœåŠ¡ä¼˜åŒ–** (`lib/ai/services/trend-service.ts`)

```typescript
withRetry(
  async () => { /* ... */ },
  RetryPresets.quick  // âœ… ä½¿ç”¨ quick é¢„è®¾
)
```

### 4. **API è·¯ç”±è¶…æ—¶é…ç½®**

ä¸ºæ‰€æœ‰ AI API ç«¯ç‚¹æ·»åŠ è¶…æ—¶é…ç½®ï¼š

| ç«¯ç‚¹ | `maxDuration` | è¯´æ˜ |
|------|---------------|------|
| `/api/ai/trend` | 30s | è¶‹åŠ¿åˆ†æ |
| `/api/ai/summary` | 30s | å†…å®¹æ‘˜è¦ |
| `/api/ai/sentiment` | 20s | æƒ…æ„Ÿåˆ†æ |
| `/api/ai/keywords/cluster` | 25s | å…³é”®è¯èšç±» |
| `/api/ai/batch` | 60s | æ‰¹é‡ä»»åŠ¡ï¼ˆè¾ƒé•¿ï¼‰ |
| `/api/ai/stats` | 10s | ç»Ÿè®¡æŸ¥è¯¢ï¼ˆå¿«é€Ÿï¼‰ |

```typescript
// æ¯ä¸ª route.ts æ·»åŠ 
export const maxDuration = 30; // ç§’
export const dynamic = 'force-dynamic';
```

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä¹‹å‰:
```
è¯·æ±‚æµç¨‹:
API è°ƒç”¨ â†’ é‡è¯• 1 (30s è¶…æ—¶) â†’ å¤±è´¥
         â†’ é‡è¯• 2 (30s è¶…æ—¶) â†’ å¤±è´¥  
         â†’ é‡è¯• 3 (30s è¶…æ—¶) â†’ å¤±è´¥
         â†’ Fallback (è§„åˆ™åˆ†æ)
æ€»æ—¶é—´: ~93 ç§’
```

### ä¹‹å:
```
è¯·æ±‚æµç¨‹:
API è°ƒç”¨ â†’ å¿«é€Ÿè¯·æ±‚ (20s DeepSeek è¶…æ—¶, 15s é‡è¯•ä¿æŠ¤) â†’ å¤±è´¥
         â†’ ç­‰å¾… 1s â†’ é‡è¯• (15s) â†’ å¤±è´¥
         â†’ ç­‰å¾… 2s â†’ Fallback (è§„åˆ™åˆ†æ)
æ€»æ—¶é—´: ~35 ç§’ (å‡å°‘ 62%)
```

### æ€§èƒ½æå‡:
- âš¡ **å“åº”æ—¶é—´**: 93s â†’ 35sï¼ˆå‡å°‘ 62%ï¼‰
- ğŸ¯ **å¤±è´¥æ£€æµ‹**: æ›´å¿«è¿›å…¥ Fallback
- ğŸ’° **æˆæœ¬ä¼˜åŒ–**: å‡å°‘æ— æ•ˆçš„é•¿æ—¶é—´ç­‰å¾…
- ğŸ‘ **ç”¨æˆ·ä½“éªŒ**: æ›´å¿«çš„åé¦ˆ

## ğŸ›¡ï¸ Fallback æœºåˆ¶

å½“ AI æœåŠ¡è¶…æ—¶/å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨è§„åˆ™åˆ†æï¼š

```typescript
function analyzeTrendsFallback(newsItems: NewsItem[]) {
  // åŸºäºè¯é¢‘åˆ†æ
  // æå–å¸¸è§å…³é”®è¯
  // ç”ŸæˆåŸºç¡€è¶‹åŠ¿æŠ¥å‘Š
}
```

**Fallback ä¼˜åŠ¿**:
- âœ… ä¿è¯æœåŠ¡å¯ç”¨æ€§
- âœ… æä¾›åŸºç¡€åˆ†æç»“æœ
- âœ… ä¸ä¼šå®Œå…¨å¤±è´¥
- âœ… ç”¨æˆ·ä½“éªŒé™çº§è€Œéä¸­æ–­

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. âœ… `lib/ai/deepseek-client.ts` - æ·»åŠ è¶…æ—¶å’Œé‡è¯•é…ç½®
2. âœ… `lib/ai/utils/retry-handler.ts` - æ·»åŠ  quick é¢„è®¾
3. âœ… `lib/ai/services/trend-service.ts` - ä½¿ç”¨ quick é‡è¯•ç­–ç•¥
4. âœ… `app/api/ai/trend/route.ts` - æ·»åŠ  maxDuration
5. âœ… `app/api/ai/summary/route.ts` - æ·»åŠ  maxDuration
6. âœ… `app/api/ai/sentiment/route.ts` - æ·»åŠ  maxDuration
7. âœ… `app/api/ai/keywords/cluster/route.ts` - æ·»åŠ  maxDuration
8. âœ… `app/api/ai/batch/route.ts` - æ·»åŠ  maxDuration
9. âœ… `app/api/ai/stats/route.ts` - æ·»åŠ  maxDuration

## ğŸ§ª æµ‹è¯•å»ºè®®

1. **å¿«é€Ÿè¶…æ—¶æµ‹è¯•**:
   ```bash
   # æµ‹è¯•è¶‹åŠ¿åˆ†æç«¯ç‚¹
   curl -X POST http://localhost:3000/api/ai/trend \
     -H "Content-Type: application/json" \
     -d '{"news_items": [...], "time_range": "week"}'
   ```

2. **ç›‘æ§æ—¥å¿—**:
   ```
   âœ… æœŸæœ›: [RetryHandler] å°è¯•æ¬¡æ•°ä¸è¶…è¿‡ 2-3 æ¬¡
   âœ… æœŸæœ›: æ€»å“åº”æ—¶é—´ < 40 ç§’
   âœ… æœŸæœ›: Fallback åœ¨ 35 ç§’å†…è§¦å‘
   ```

3. **å‹åŠ›æµ‹è¯•**:
   - å¹¶å‘ 10 ä¸ªè¯·æ±‚
   - éªŒè¯è¶…æ—¶æœºåˆ¶ç¨³å®šæ€§
   - ç¡®è®¤ Fallback æ­£å¸¸å·¥ä½œ

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ä¼˜åŒ–**:
   - âœ… å·²å¯ç”¨ LRU ç¼“å­˜ï¼ˆTTL: 1å°æ—¶ï¼‰
   - è€ƒè™‘å¢åŠ ç¼“å­˜é¢„çƒ­
   - æ·»åŠ ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§

2. **è¯·æ±‚ä¼˜åŒ–**:
   - é™åˆ¶æ–°é—»æ¡ç›®æ•°é‡ï¼ˆå½“å‰ï¼šæœ€å¤š 30 æ¡ï¼‰
   - è€ƒè™‘åˆ†æ‰¹å¤„ç†å¤§é‡æ•°æ®
   - æ·»åŠ è¯·æ±‚å»é‡

3. **ç›‘æ§å‘Šè­¦**:
   - æ·»åŠ è¶…æ—¶ç‡ç›‘æ§
   - è®¾ç½® Fallback ä½¿ç”¨ç‡å‘Šè­¦
   - è·Ÿè¸ª DeepSeek API å“åº”æ—¶é—´

4. **é™çº§ç­–ç•¥**:
   - é«˜å³°æœŸè‡ªåŠ¨é™ä½ AI è°ƒç”¨é¢‘ç‡
   - ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ç»“æœ
   - æ™ºèƒ½ Fallback åˆ‡æ¢

## ğŸ“ˆ é¢„æœŸç»“æœ

- âœ… è¶‹åŠ¿åˆ†æè¶…æ—¶é—®é¢˜è§£å†³
- âœ… å“åº”æ—¶é—´ä» 93 ç§’é™è‡³ 35 ç§’ä»¥å†…
- âœ… Fallback æœºåˆ¶å¯é è§¦å‘
- âœ… ç”¨æˆ·ä½“éªŒæ˜æ˜¾æå‡
- âœ… æˆæœ¬æ§åˆ¶æ›´æœ‰æ•ˆ

---

**ä¿®å¤æ—¶é—´**: 2025-11-07  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•  
**å½±å“èŒƒå›´**: æ‰€æœ‰ AI API ç«¯ç‚¹
